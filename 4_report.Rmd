
---
title: "4_report"
author: "SL"
date: "5/17/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(haven)
library(Hmisc)
library(janitor)
library(skimr)
library(zoo)
library(naniar)
library(scales)
library(viridis)
library(RColorBrewer)
library(ggrepel)

```



```{r}

df_hsi <- read_rds("data/df_hsi.rds")

Hmisc::describe(df_hsi)

hsi_factors <- read_rds("data/hsi_factors.rds")
```


## Table 1


Recode for display
Restrict to years: 1998 - 2019

```{r}
df_hsi_table_other <-
  df_hsi %>%
    dplyr::filter(year > 1997 & year < 2020) %>% 
     dplyr::select(source, age, sex, race_ethnic, service, grade, hsi, bmi, casedef, bmi_cat, year) %>% 
       mutate(service = recode_factor(service,
            "A" = "Army",
            "N" = "Navy",
            "F" = "Air Force",
            "M" = "Marine Corps",
            "C" = "Coast Guard"
            ),
            source = recode_factor(source,
            "INPATIENT" = "In-Patient",
            "OUTPATIENT" = "Out-Patient",
            "RME" = "Reportable Event"),
            hsi = recode_factor(hsi,
            "heat_stroke" = "Heat Stroke",
            "heat_exhaustion" = "Heat Exhaustion",
            "other" = "Other"),
            sex = recode_factor(sex,
            "M" = "Male",
            "F" = "Female",
            "Z" = "Unknown")
            ) %>% 
            haven::zap_label()




df_hsi_table <-
  df_hsi_table_other %>%
    dplyr::filter(!hsi %in% "Other") 

    
```


## Outcome table including "other HSI"
```{r}

# by casedef (keep "1" and "overall" columns)
table1::table1(~ hsi + source + sex + age + sex + race_ethnic + grade + service + bmi + bmi_cat  | casedef, data = df_hsi_table_other)


```

## Restrict to heat stroke and heat exhaustion

```{r}

table_1 <-
 table1::table1(~ hsi + source + sex + age + sex + race_ethnic + grade + service + bmi + bmi_cat  | casedef, data = df_hsi_table)    

table_1
```



## BMI Table

Restrict to Age < 25
Case-definition applied


```{r}

df_hsi_table_bmi <-
  df_hsi_table %>% 
    dplyr::filter(age %in% c("<20", "20-24"),
                  casedef == 1)


table1::table1(~ bmi |  hsi, data = df_hsi_table_bmi)
table1::table1(~ bmi |  source, data = df_hsi_table_bmi)    
table1::table1(~ bmi |  sex, data = df_hsi_table_bmi)
table1::table1(~ bmi |  race_ethnic, data = df_hsi_table_bmi)
table1::table1(~ bmi |  grade, data = df_hsi_table_bmi)    
table1::table1(~ bmi |  as_factor(year), data = df_hsi_table_bmi)   

table1::table1(~ bmi |  hsi * source, data = df_hsi_table_bmi)  
table1::table1(~ bmi_cat |  hsi * source, data = df_hsi_table_bmi)  
```


Including "other" hsi

```{r}
df_hsi_table_bmi_other <-
  df_hsi_table_other %>% 
    dplyr::filter(age %in% c("<20", "20-24"),
                  casedef == 1)


table1::table1(~ bmi |  hsi, data = df_hsi_table_bmi_other)
table1::table1(~ bmi |  source, data = df_hsi_table_bmi_other)    

table1::table1(~ bmi |  hsi * source, data = df_hsi_table_bmi_other)  
table1::table1(~ bmi_cat |  hsi * source, data = df_hsi_table_bmi_other) 

```



## Figures


```{r}
# Case definition

df_hsi_table %>%
  dplyr::filter(casedef == 1) %>% 
  group_by(year, hsi) %>%
  summarise(n = dplyr::n()) %>%
  ggplot(aes(x = year, y = n, color = hsi)) +
    geom_point(size = 1.5) +
    geom_line(size = 1.5) +
    geom_smooth(method = lm) +
  labs(x = "Year",
       color = "Diagnosis") +
  theme_bw() +
  scale_x_continuous(breaks = scales::breaks_pretty(n = 9))

# ggsave(filename = "output/case_def_line_plot.png")

# linear model 

lm_models <-
  df_hsi_table %>%
    dplyr::filter(casedef == 1) %>% 
    group_by(year, hsi) %>%
    summarise(n = dplyr::n()) %>%
    nest(data = -hsi) %>% 
    mutate(lm_mod =
             map(.$data, ~lm(n ~ year, data = .x))
    )


lm_models$lm_mod %>% map(., broom::tidy)
lm_models$lm_mod %>% map(., broom::glance)
    


df_hsi_table %>%
  dplyr::filter(casedef == 1) %>% 
  group_by(year, hsi, source) %>%
  summarise(n = dplyr::n()) %>%
  ggplot(aes(x = year, y = n, color = hsi)) +
    geom_point(size = 1.5) +
    geom_line(size = 1.5) +
    geom_smooth(method = lm) +
    facet_grid(source ~.) +
  labs(x = "Year",
       color = "Type") +
  theme_bw() 




# all encounters, with other

df_hsi_table_other %>%
  group_by(year, hsi) %>%
  summarise(n = dplyr::n()) %>%
  ggplot(aes(x = year, y = n, color = hsi)) +
    geom_point(size = 1.6) +
    geom_line(size = 1.5) +
    geom_smooth(method = lm, alpha = 0.2) +
  labs(x = "Year",
       color = "Type") +
  theme_bw() 


df_hsi_table_other %>%
  group_by(year, hsi, source) %>%
  summarise(n = dplyr::n()) %>%
  ggplot(aes(x = year, y = n, color = hsi)) +
    geom_point(size = 1.6) +
    geom_line(size = 1.5) +
    geom_smooth(method = lm, alpha = 0.2) +
  facet_grid(source ~.) +
  labs(x = "Year",
       color = "Type") +
  theme_bw() 

```



# Risk plot
```{r}
cbp1 <- c("#999999", "#E69F00", "#56B4E9", "#009E73",
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7",
          "#999999", "#E69F00", "#56B4E9", "#009E73",
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7",
          "#999999", "#E69F00", "#56B4E9", "#009E73")




hsi_factors %>%
   mutate(label = if_else(year == max(year), as.character(var), NA_character_),
          Risk = risk * 10000) %>%
   ggplot(aes(x = as.integer(year), y = Risk)) +
    geom_line(aes(color = var), size = 1.5) +
    geom_point(aes(shape = var), size = 1.5) +
    facet_grid(cat~.) +
    geom_text_repel(aes(label = label),
                  nudge_x = 1,
                  size = 3,
                  na.rm = TRUE) +
    theme_bw() +
    theme(legend.position = "none") +
    scale_shape_manual(values = rep(c(0:10, 12, 13, 15:20), 2)) +
    scale_colour_manual(values = cbp1) +
    #scale_color_viridis(discrete = TRUE) +
    scale_x_continuous(breaks = scales::pretty_breaks(10)) + 
    labs(x = "Year",
         y = "HSI cases per 10,000")

# ggsave("output/risk_plot.png")  


var_names <- as_labeller(
     c(`age` = "Age", `grade` = "Grade",`race` = "Race", 
       `service` = "Service",`sex` = "Sex"))


hsi_factors %>%
   mutate(label = if_else(year == max(year), as.character(var), NA_character_),
          Risk = risk * 10000) %>%
   ggplot(aes(x = as.integer(year), y = Risk)) +
    geom_line(aes(color = var), size = 1.5) +
    geom_point(aes(shape = var), size = 1.5) +
    facet_grid(~cat, labeller = var_names) +
    geom_label_repel(aes(label = label),
                  nudge_x = 0,
                  size = 3,
                  fontface = "bold",
                  na.rm = TRUE) +
    theme_bw() +
    theme(legend.position = "none") +
    scale_shape_manual(values = rep(c(0:10, 12, 13, 15:20), 2)) +
    scale_colour_manual(values = cbp1) +
    #scale_color_viridis(discrete = TRUE) +
    scale_x_continuous(breaks = scales::pretty_breaks(8)) + 
    labs(x = "Year",
         y = "HSI cases per 10,000") +
    theme(axis.text.x = element_text(angle = 90)) 

# ggsave("output/risk_plot_horiz.png")  
```


